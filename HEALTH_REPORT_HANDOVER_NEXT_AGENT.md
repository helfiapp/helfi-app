# Weekly Health Report (7-day) - Detailed Handover For Next Agent

Last updated: 2026-02-08

This handover is written so the owner (non-technical) can understand what is going on, while also giving the next agent enough detail to continue the work without repeating mistakes.

---

## 1) What The Owner Is Seeing (Problems)

### A) "Weekly reports are turned off" even after generating a report
The owner generated a report in a Vercel preview build, clicked "View report", and got a screen saying weekly reports are turned off (with buttons like "Go to settings" and "Upgrade").

Owner expectation:
- If the owner is a premium/paid user, weekly reports should never randomly appear "turned off".
- If a report exists, "View report" should always show it.

### B) The report content is wrong/confusing (major trust issue)
In the Supplements section:
- The report shows **Tadalafil** inside supplements-related content.
  - Owner note: Tadalafil is a medication and should not be in the Supplements section.
- The report "suggests" supplements the owner already takes.
  - Example: items shown under "Suggestions" that are already in their supplement list.

This makes the report feel broken and untrustworthy, even if other sections look good.

### C) The PDF report looks very poor
The PDF export is currently a very basic layout with tiny/simple charts and minimal styling. It does not match the modern "crown jewel" feel of the web report page.

File: `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/api/reports/weekly/pdf/route.ts`

---

## 2) What Was Implemented (So Far)

### A) "Crown jewel" web report visuals (charts + app-like mobile feel)
Added a "Visual snapshot" section with charts and donut/pie charts, plus a mobile-style header and bottom navigation inside the report page.

Files:
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/insights/weekly-report/ReportVisuals.tsx`
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/insights/weekly-report/WeeklyReportClient.tsx`

### B) Stop claiming "sleep consistency" without real device sleep data
The owner does not have a Garmin/Fitbit, so the report must not mention "sleep consistency" unless real sleep tracking data exists.

Change:
- Added a strict instruction to the report-writing prompt to not mention sleep consistency unless sleep tracking data is present.

File:
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/api/reports/weekly/run/route.ts`

### C) Supplements: show the user's full supplement list (name + dose + timing)
To reduce confusion, the Supplements tab now shows a "Your supplements" list, using the saved supplement list (and dose/timing if present).

File:
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/insights/weekly-report/WeeklyReportClient.tsx`

### D) Attempted fix: weekly reports should not look "off" for paid users
The preview builds were showing weekly reports as off because the saved weekly report "state" is inconsistent (details below).

Changes were made to:
- Make state reading more robust
- Persist `reportsEnabled` and `reportsEnabledAt` properly when saving state
- For paid users on /insights, auto-enable weekly reports so it doesn’t silently appear off
- On the report page, if a report exists, do not block the page with a "reports are off" screen

Files:
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/lib/weekly-health-report.ts`
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/insights/page.tsx`
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/insights/weekly-report/page.tsx`

Important: This is in the preview branch only (not deployed to live).

---

## 3) What Is Still Failing (Critical)

### A) The report writer can put the wrong items in the wrong section
Example: medication showing inside Supplements.

Likely reason:
- The report is generated by an AI prompt and it can mis-classify items.
- Even if the JSON includes "medications" and "supplements" separately, the AI can still put a medication in the supplements section.

This needs a hard safety system:
- Stronger AI rules
- AND a "clean-up" step on the server after the AI returns the JSON (before saving).

### B) The report writer can suggest something the user already takes
Example: Supplements "Suggestions" repeats items already in the user's supplement list.

This also needs a hard safety system:
- Server-side clean-up should remove duplicates and prevent the report from suggesting the same thing the user already takes.

### C) PDF quality is far below expectations
The PDF export is built using `pdf-lib` and manual drawing. It looks like a basic internal report, not a premium "crown jewel" report.

File:
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/api/reports/weekly/pdf/route.ts`

---

## 4) Root Causes (What Actually Went Wrong)

### A) Weekly report “ON/OFF” state is stored inconsistently
The table `WeeklyHealthReportState` has these columns:
- `reportsEnabled` (boolean)
- `reportsEnabledAt` (timestamp)
- `nextReportDueAt` (timestamp)

But historically:
- The code often treated weekly reports as enabled only when `nextReportDueAt` was set.
- The code that writes state (`upsertWeeklyReportState`) was not inserting `reportsEnabled` and `reportsEnabledAt` at all.
- A "backfill" exists that creates a row with `nextReportDueAt = null`, which makes the UI say weekly reports are off.

So paid users can end up seeing:
- "Weekly reports are off by default"
even though they are premium and/or have created reports.

### B) The AI report JSON is not enforced
Right now the AI output is accepted too easily. If it:
- mixes medications into supplements
- suggests supplements already taken
the UI will show it as-is.

---

## 5) Recommended Fix Plan (Next Agent)

### Step 1: Enforce correct classification (no meds in supplements)
Add a server-side "sanitize" step in:
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/api/reports/weekly/run/route.ts`

Basic idea:
- Build two name lists from the real user routine:
  - `knownSupplements` (from reportContext.supplements)
  - `knownMedications` (from reportContext.medications)
- After the AI returns `reportPayload.sections`, do these rules:
  - If an item in `sections.supplements.*` matches a known medication name:
    - remove it from supplements
    - move it to `sections.medications.working` (or suggested/avoid depending on context)
  - If an item in `sections.medications.*` matches a known supplement name:
    - move it the other way
  - If a "suggested" supplement matches a known supplement:
    - remove it from suggested (it is not a suggestion if already taken)
    - optionally move it into "working" with wording like "Already in your routine"

This avoids the AI breaking trust even when the AI output is imperfect.

### Step 2: Fix weekly reports ON/OFF so premium never looks off
Two rules to enforce:
1) If user has a paid plan, weekly reports should show as ON.
2) If a report exists, the report page should show the report (never block with "reports off").

Files already modified on the preview branch:
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/lib/weekly-health-report.ts`
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/insights/page.tsx`
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/insights/weekly-report/page.tsx`

Validate with the QA account:
- info@sonicweb.com.au

### Step 3: Make the PDF match the “crown jewel” standard
Current PDF route:
- `/Volumes/U34 Bolt/HELFI APP/helfi-app/app/api/reports/weekly/pdf/route.ts`

Right now it:
- draws a basic title + summary + tiny charts
- does not include the new "Visual snapshot" charts
- does not include supplements/medications sections in a meaningful way

Recommended approaches (pick one):
- Option A (best-looking): render a dedicated HTML "print view" page and generate a PDF from it.
- Option B (safer on Vercel): keep pdf-lib but redesign the typography, spacing, and include key sections (including supplements/medications) with a clean layout.

---

## 6) Preview Branch / Builds (So The Next Agent Can Reproduce)

Branch:
- `codex/weekly-report-charts`

Commits on this branch:
- `d201efe3` Weekly report visuals + charts + mobile report nav + no sleep consistency claims
- `d3ed07c9` Supplements: show supplement list; require deeper supplement coverage in AI prompt
- `d7dde09b` Weekly reports: keep enabled for paid users; don’t block viewing existing reports

Latest preview build (READY at time of writing):
- https://helfi-bzsbho05u-louie-veleskis-projects.vercel.app

Older previews from earlier steps (also READY when created):
- https://helfi-b4s21ofpw-louie-veleskis-projects.vercel.app
- https://helfi-5tpovg1p3-louie-veleskis-projects.vercel.app

---

## 7) Notes On What I Did Wrong / What I Did Not Finish

1) I focused too much on visuals first.
   - The visuals improved, but the report "trust" issues (wrong items in the wrong places) were not solved.

2) I did not implement the server-side "clean-up" step yet.
   - This is the most important missing piece to stop hallucinated/misplaced items.

3) I did not redesign the PDF.
   - The current PDF is functional but not acceptable as a premium product output.

---

## 8) Linear Ticket

This work is tracked in Linear:
- Project: Helfi Dev
- Ticket: HEL-10

