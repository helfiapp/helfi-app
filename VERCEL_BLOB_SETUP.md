# PDF Lab Report Intake & Encryption - Vercel Blob Setup Guide

## ✅ Updated for Vercel Blob Storage

The implementation has been updated to use **Vercel Blob Storage** instead of AWS S3. This is much simpler and integrates perfectly with your Vercel hosting!

## Quick Setup Steps

### 1. Enable Vercel Blob in Your Project

1. Go to your [Vercel Dashboard](https://vercel.com/dashboard)
2. Select your project
3. Go to the **Storage** tab
4. Click **Create Database** → Select **Blob**
5. Vercel will automatically add `BLOB_READ_WRITE_TOKEN` to your environment variables

### 2. Generate Encryption Master Key

You need to generate a master encryption key for encrypting lab values:

```bash
# Generate a secure random key (32 bytes, base64 encoded)
openssl rand -base64 32
```

Copy the output - you'll add it to your environment variables.

### 3. Add Environment Variables

Add these to your Vercel project settings (or `.env.local` for local development):

```bash
# Vercel Blob (auto-added when you create Blob storage)
BLOB_READ_WRITE_TOKEN=vercel_blob_xxxxx

# Encryption Master Key (generate with openssl rand -base64 32)
ENCRYPTION_MASTER_KEY=your-generated-key-here

# Optional: Upload limits
MAX_UPLOAD_MB=25
```

**Important:** 
- The `BLOB_READ_WRITE_TOKEN` is automatically added by Vercel when you create Blob storage
- The `ENCRYPTION_MASTER_KEY` must be generated by you - keep it secret!

### 4. Run Database Migration

Run the Prisma migration to create the new tables:

```bash
npx prisma migrate dev --name pdf_encryption_pipeline
```

Or if you prefer to push directly:

```bash
npx prisma db push
```

## How It Works

### Upload Flow:
1. User selects PDF and provides consent
2. **POST /api/reports/presign** - Creates report record and consent record
3. **POST /api/reports/[id]/upload** - Uploads PDF directly to Vercel Blob
4. **POST /api/reports/[id]/process** - Processes PDF, extracts lab values, encrypts data

### Encryption:
- Uses **AES-256-GCM** for field-level encryption
- Master key stored in `ENCRYPTION_MASTER_KEY` environment variable
- Each lab value gets its own encrypted data key (envelope encryption)
- No AWS KMS needed!

### Storage:
- PDFs stored in **Vercel Blob** (private access)
- Blob URL stored in report metadata
- Original PDFs deleted by default (unless user opts to retain)

## Testing

1. **Test Upload:**
   - Go to `/lab-reports` page
   - Upload a test PDF
   - Check that it processes successfully

2. **Test Password-Protected PDF:**
   - Upload a password-protected PDF
   - Enter password
   - Verify it decrypts correctly

3. **Verify Encryption:**
   - Check database `LabResult` table
   - Values should be encrypted (not plain text)

4. **Check Audit Logs:**
   - Check `AuditEvent` table
   - Should see events for upload, processing, encryption

## Troubleshooting

### "BLOB_READ_WRITE_TOKEN not configured"
- Make sure you've created Blob storage in Vercel dashboard
- Check that the token is in your environment variables

### "ENCRYPTION_MASTER_KEY not configured"
- Generate a key: `openssl rand -base64 32`
- Add it to your environment variables

### "Failed to fetch PDF from blob"
- Check that the blob was uploaded successfully
- Verify the blob URL is stored in report metadata
- Check that `BLOB_READ_WRITE_TOKEN` is correct

### Migration Errors
- Try `npx prisma db push` instead of migrate
- Check that your database connection is working
- Verify Prisma schema syntax

## Security Notes

- ✅ **Encryption keys** stored in Vercel environment variables (encrypted at rest)
- ✅ **PDFs** stored in Vercel Blob with private access
- ✅ **Passwords** never stored (ephemeral use only)
- ✅ **Full audit trail** for compliance
- ✅ **Field-level encryption** for all sensitive data

## Cost Considerations

- **Vercel Blob**: 
  - Free tier: 1 GB storage, 100 GB bandwidth/month
  - Paid: $0.15/GB storage, $0.15/GB bandwidth
- **Encryption**: Free (uses Node.js crypto)
- **Database**: Your existing PostgreSQL costs

## Next Steps

1. ✅ Enable Vercel Blob storage
2. ✅ Generate encryption master key
3. ✅ Add environment variables
4. ✅ Run database migration
5. ✅ Test upload flow
6. ✅ Deploy to production

## Support

For issues:
- Check Vercel Blob docs: https://vercel.com/docs/storage/vercel-blob
- Check Prisma docs: https://www.prisma.io/docs
- Review code comments in implementation files

