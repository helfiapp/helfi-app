generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model AdminUser {
  id             String           @id
  email          String           @unique
  password       String
  name           String
  isActive       Boolean          @default(true)
  lastLogin      DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  createdBy      String?
  role           AdminRole        @default(ADMIN)
  SupportTicket  SupportTicket[]
  TicketResponse TicketResponse[]
}

model AuditEvent {
  id               String         @id
  reportId         String?
  userId           String
  eventType        AuditEventType
  eventDescription String
  metadata         Json?
  ipAddress        String?
  userAgent        String?
  createdAt        DateTime       @default(now())
  Report           Report?        @relation(fields: [reportId], references: [id])

  @@index([eventType, createdAt])
  @@index([reportId])
  @@index([userId, createdAt])
}

model ConsentRecord {
  id                String      @id
  userId            String
  consentType       ConsentType @default(PDF_DECRYPTION)
  consentText       String
  decryptionConsent Boolean
  passwordConsent   Boolean
  retentionConsent  Boolean     @default(false)
  ipAddress         String?
  userAgent         String?
  consentedAt       DateTime    @default(now())
  User              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  Report            Report[]

  @@index([userId, consentedAt])
}

model CreditTopUp {
  id          String   @id
  userId      String
  amountCents Int
  usedCents   Int      @default(0)
  purchasedAt DateTime @default(now())
  expiresAt   DateTime
  source      String?
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model EmailTemplate {
  id        String        @id
  name      String
  category  EmailCategory @default(MARKETING)
  subject   String
  content   String
  isActive  Boolean       @default(true)
  isBuiltIn Boolean       @default(false)
  createdBy String?
  createdAt DateTime      @default(now())
  updatedAt DateTime
}

model ExerciseLog {
  id        String   @id
  userId    String
  type      String
  duration  Int
  intensity String?
  notes     String?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model File {
  id                           String       @id
  originalName                 String
  fileName                     String
  fileSize                     Int
  mimeType                     String
  cloudinaryId                 String
  cloudinaryUrl                String
  secureUrl                    String
  uploadedById                 String
  fileType                     FileType     @default(IMAGE)
  usage                        FileUsage    @default(OTHER)
  metadata                     Json?
  isPublic                     Boolean      @default(false)
  createdAt                    DateTime     @default(now())
  updatedAt                    DateTime
  User_File_uploadedByIdToUser User         @relation("File_uploadedByIdToUser", fields: [uploadedById], references: [id], onDelete: Cascade)
  FoodLog                      FoodLog[]    @relation("FoodLogImages")
  Medication                   Medication[] @relation("MedicationImages")
  User_ProfileImages           User[]       @relation("ProfileImages")
  Supplement                   Supplement[] @relation("SupplementImages")
}

model FitbitData {
  id        String   @id
  userId    String
  date      DateTime @db.Date
  dataType  String
  value     Json
  syncedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, dataType])
  @@index([userId, dataType])
  @@index([userId, date])
}

model FoodLog {
  id          String   @id
  userId      String
  name        String
  imageUrl    String?
  description String?
  nutrients   Json?
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  File        File[]   @relation("FoodLogImages")
}

model HealthGoal {
  id            String      @id
  userId        String
  name          String
  category      String
  currentRating Int
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  User          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  HealthLog     HealthLog[]
}

model HealthLog {
  id         String     @id
  userId     String
  goalId     String
  rating     Int
  notes      String?
  createdAt  DateTime   @default(now())
  HealthGoal HealthGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  User       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model InsightsChatMessage {
  id                 String             @id
  threadId           String
  role               String
  content            String
  tokenCount         Int?
  createdAt          DateTime           @default(now()) @db.Timestamptz(6)
  InsightsChatThread InsightsChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([threadId, createdAt])
}

model InsightsChatThread {
  id                  String                @id
  userId              String
  slug                String
  section             String
  createdAt           DateTime              @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime              @default(now()) @db.Timestamptz(6)
  title               String?
  InsightsChatMessage InsightsChatMessage[]

  @@index([userId, slug, section], map: "InsightsChatThread_user_slug_section_idx")
}

model InsightsMetadata {
  userId          String
  issueSlug       String
  section         String
  lastGeneratedAt DateTime @default(now()) @db.Timestamptz(6)
  dataFingerprint String
  status          String   @default("fresh")
  updatedAt       DateTime @default(now()) @db.Timestamptz(6)

  @@id([userId, issueSlug, section])
}

model InsightsSectionCache {
  userId    String
  slug      String
  section   String
  mode      String
  rangeKey  String
  result    Json
  updatedAt DateTime @default(now()) @db.Timestamptz(6)

  @@id([userId, slug, section, mode, rangeKey])
}

model InteractionAnalysis {
  id                  String   @id
  userId              String
  analysisName        String
  overallRisk         String
  supplementCount     Int      @default(0)
  medicationCount     Int      @default(0)
  analysisData        Json
  supplementsAnalyzed Json
  medicationsAnalyzed Json
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  User                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model LabResult {
  id                       String   @id
  reportId                 String
  analyteNameEncrypted     String
  valueEncrypted           String
  unitEncrypted            String?
  referenceRangeEncrypted  String?
  collectionDateEncrypted  String?
  accessionNumberEncrypted String?
  laboratoryNameEncrypted  String?
  dataKeyEncrypted         String
  createdAt                DateTime @default(now())
  updatedAt                DateTime
  Report                   Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
}

model Medication {
  id        String   @id
  userId    String
  name      String
  dosage    String
  timing    String[]
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  File      File[]   @relation("MedicationImages")
}

model Report {
  id                    String        @id
  userId                String
  originalFileName      String
  s3Key                 String
  fileSize              Int
  mimeType              String        @default("application/pdf")
  status                ReportStatus  @default(PENDING)
  isPasswordProtected   Boolean       @default(false)
  passwordHash          String?
  retainOriginal        Boolean       @default(false)
  originalDeletedAt     DateTime?
  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  processingError       String?
  consentRecordId       String
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime
  AuditEvent            AuditEvent[]
  LabResult             LabResult[]
  ConsentRecord         ConsentRecord @relation(fields: [consentRecordId], references: [id], onDelete: Cascade)
  User                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([consentRecordId])
  @@index([status])
  @@index([userId, createdAt])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                String    @id
  userId            String    @unique
  plan              Plan      @default(PREMIUM)
  startDate         DateTime  @default(now())
  endDate           DateTime?
  monthlyPriceCents Int?
  User              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Supplement {
  id        String   @id
  userId    String
  name      String
  dosage    String
  timing    String[]
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  File      File[]   @relation("SupplementImages")
}

model SupportTicket {
  id                String           @id
  subject           String
  message           String
  userEmail         String
  userName          String?
  userId            String?
  status            TicketStatus     @default(OPEN)
  priority          TicketPriority   @default(MEDIUM)
  category          TicketCategory   @default(GENERAL)
  externalMessageId String?
  assignedAdminId   String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime
  AdminUser         AdminUser?       @relation(fields: [assignedAdminId], references: [id])
  User              User?            @relation(fields: [userId], references: [id])
  TicketResponse    TicketResponse[]
}

model TalkToAIChatMessage {
  id                 String             @id
  threadId           String
  role               String
  content            String
  tokenCount         Int?
  createdAt          DateTime           @default(now()) @db.Timestamptz(6)
  TalkToAIChatThread TalkToAIChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([threadId, createdAt])
}

model TalkToAIChatThread {
  id                  String                @id
  userId              String
  title               String?
  createdAt           DateTime              @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime              @default(now()) @db.Timestamptz(6)
  TalkToAIChatMessage TalkToAIChatMessage[]

  @@index([userId])
}

model TicketResponse {
  id              String        @id
  ticketId        String
  message         String
  isAdminResponse Boolean       @default(false)
  adminId         String?
  userEmail       String?
  createdAt       DateTime      @default(now())
  AdminUser       AdminUser?    @relation(fields: [adminId], references: [id])
  SupportTicket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model User {
  id                              String                @id
  email                           String                @unique
  name                            String?
  image                           String?
  gender                          Gender?
  weight                          Float?
  height                          Float?
  bodyType                        BodyType?
  createdAt                       DateTime              @default(now())
  updatedAt                       DateTime
  emailVerified                   DateTime?
  exerciseFrequency               String?
  exerciseTypes                   String[]
  additionalCredits               Int                   @default(0)
  dailyAnalysisCredits            Int                   @default(3)
  dailyAnalysisUsed               Int                   @default(0)
  lastAnalysisResetDate           DateTime?
  totalAnalysisCount              Int                   @default(0)
  dailyFoodAnalysisUsed           Int                   @default(0)
  dailyInteractionAnalysisUsed    Int                   @default(0)
  totalFoodAnalysisCount          Int                   @default(0)
  totalInteractionAnalysisCount   Int                   @default(0)
  dailyMedicalAnalysisUsed        Int                   @default(0)
  monthlyInteractionAnalysisUsed  Int                   @default(0)
  lastMonthlyResetDate            DateTime?
  dailyFoodReanalysisUsed         Int                   @default(0)
  termsAccepted                   Boolean               @default(false)
  walletMonthlyUsedCents          Int                   @default(0)
  walletMonthlyResetAt            DateTime?
  hasUsedFreeFoodAnalysis         Boolean               @default(false)
  hasUsedFreeInteractionAnalysis  Boolean               @default(false)
  hasUsedFreeMedicalAnalysis      Boolean               @default(false)
  monthlySymptomAnalysisUsed      Int                   @default(0)
  monthlyFoodAnalysisUsed         Int                   @default(0)
  monthlyMedicalImageAnalysisUsed Int                   @default(0)
  monthlyInsightsGenerationUsed   Int                   @default(0)
  Account                         Account[]
  ConsentRecord                   ConsentRecord[]
  CreditTopUp                     CreditTopUp[]
  ExerciseLog                     ExerciseLog[]
  File_File_uploadedByIdToUser    File[]                @relation("File_uploadedByIdToUser")
  FitbitData                      FitbitData[]
  FoodLog                         FoodLog[]
  HealthGoal                      HealthGoal[]
  HealthLog                       HealthLog[]
  InteractionAnalysis             InteractionAnalysis[]
  Medication                      Medication[]
  Report                          Report[]
  Session                         Session[]
  Subscription                    Subscription?
  Supplement                      Supplement[]
  SupportTicket                   SupportTicket[]
  File_ProfileImages              File[]                @relation("ProfileImages")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Waitlist {
  id           String   @id
  email        String   @unique
  name         String
  createdAt    DateTime @default(now())
  unsubscribed Boolean  @default(false)
}

model checkinissues {
  id       String @id
  userid   String
  name     String
  polarity String

  @@unique([userid, name], map: "checkinissues_user_name_idx")
}

model checkinratings {
  userid  String
  issueid String
  date    String
  value   Int?
  note    String?
  isna    Boolean? @default(false)

  @@id([userid, issueid, date])
}

model pushsubscriptions {
  userid       String @id
  subscription Json
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

enum AuditEventType {
  CONSENT_GRANTED
  CONSENT_WITHDRAWN
  PDF_UPLOADED
  PDF_PROCESSING_STARTED
  PDF_PROCESSING_COMPLETED
  PDF_PROCESSING_FAILED
  PDF_DECRYPTED
  LAB_DATA_EXTRACTED
  LAB_DATA_ENCRYPTED
  ORIGINAL_DELETED
  DATA_ACCESSED
  DATA_DELETED
}

enum BodyType {
  ECTOMORPH
  MESOMORPH
  ENDOMORPH
}

enum ConsentType {
  PDF_DECRYPTION
  DATA_PROCESSING
  DATA_RETENTION
}

enum EmailCategory {
  ONBOARDING
  MARKETING
  SUPPORT
  ANNOUNCEMENTS
  RETENTION
  CUSTOM
}

enum FileType {
  IMAGE
  DOCUMENT
  VIDEO
  AUDIO
  OTHER
}

enum FileUsage {
  PROFILE_IMAGE
  FOOD_PHOTO
  SUPPLEMENT_IMAGE
  MEDICATION_IMAGE
  DOCUMENT
  OTHER
}

enum Gender {
  MALE
  FEMALE
}

enum Plan {
  PREMIUM
}

enum ReportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  DECRYPTION_FAILED
}

enum TicketCategory {
  GENERAL
  TECHNICAL
  BILLING
  ACCOUNT
  FEATURE_REQUEST
  BUG_REPORT
  EMAIL
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  AWAITING_RESPONSE
  RESPONDED
  RESOLVED
  CLOSED
}
